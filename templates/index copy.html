<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Audit Analysis Tool</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
</head>
<body>
    <div class="container">
        <header class="header">
            <div class="header-content">
                <h1 class="logo">Smart Audit Analysis Tool</h1>
                <p class="tagline">Leveraging AI for Deeper Insights & Risk Identification</p>
            </div>
        </header>

        <main class="main-content">
            <!-- Feature Selection -->
            <div id="feature-selection" class="feature-selection">
                <div class="feature-card" onclick="selectFeature('historical')">
                    <h3><i class="fas fa-history"></i> Historical Analysis</h3>
                    <p>Find similar past audits and analyze recurring issue themes.</p>
                </div>
                <div class="feature-card" onclick="selectFeature('ai')">
                    <h3><i class="fas fa-brain"></i> AI-Driven Risk Analysis</h3>
                    <p>Get a detailed, risk-based audit plan for a new process.</p>
                </div>
            </div>

            <!-- AI-Driven Analysis Form -->
            <div id="ai-analysis-form" class="card" style="display: none;">
                <div class="card-header">
                     <div>
                        <h2><i class="fas fa-magic"></i> AI-Driven Process Analysis</h2>
                        <p>Describe a process to get a detailed risk breakdown and audit plan.</p>
                    </div>
                </div>
                <div class="card-body">
                    <form id="process-analysis-form">
                        <div class="form-group">
                            <label for="process-description" class="form-label"><i class="fas fa-project-diagram label-icon"></i>Process Description</label>
                            <textarea id="process-description" class="form-control" rows="6" placeholder="e.g., Describe the end-to-end process for creating and publishing a risk-related data dashboard..."></textarea>
                        </div>
                         <div class="form-actions">
                            <button type="submit" class="btn btn-primary"><i class="fas fa-cogs btn-icon"></i>Generate Plan</button>
                             <button type="button" class="btn btn-secondary" onclick="goBack()"><i class="fas fa-arrow-left btn-icon"></i>Back</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Loading and Results Sections -->
            <div id="loading" class="loading-section" style="display: none;">
                <div class="loading-content">
                    <div class="spinner"></div>
                    <p>Analyzing... The AI is crafting your audit plan. This may take a moment.</p>
                </div>
            </div>
            <div id="results" class="results-section" style="display: none;"></div>
            <div id="error" class="error-section" style="display: none;"></div>
        </main>

        <footer class="footer">
            <p>&copy; 2025 Smart Audit Co. All Rights Reserved.</p>
        </footer>
    </div>

    <script>
        // --- UI CONTROL FUNCTIONS ---
        function selectFeature(feature) {
            document.getElementById('feature-selection').style.display = 'none';
            if (feature === 'ai') {
                document.getElementById('ai-analysis-form').style.display = 'block';
            }
        }

        function goBack() {
            document.getElementById('ai-analysis-form').style.display = 'none';
            document.getElementById('results').style.display = 'none';
            document.getElementById('error').style.display = 'none';
            document.getElementById('feature-selection').style.display = 'grid';
        }

        function showLoading() {
            document.getElementById('ai-analysis-form').style.display = 'none';
            document.getElementById('results').style.display = 'none';
            document.getElementById('error').style.display = 'none';
            document.getElementById('loading').style.display = 'block';
        }

        function hideLoading() {
            document.getElementById('loading').style.display = 'none';
        }

        function showError(message) {
            const errorContainer = document.getElementById('error');
            errorContainer.innerHTML = `<div class="error-content"><h3><i class="fas fa-exclamation-triangle"></i> An Error Occurred</h3><p>${message}</p></div>`;
            errorContainer.style.display = 'block';
            hideLoading();
        }

        // --- API AND RENDERING LOGIC ---
        const processAnalysisForm = document.getElementById('process-analysis-form');
        processAnalysisForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            const processDescription = document.getElementById('process-description').value;
            if (!processDescription.trim()) {
                showError('Please provide a process description.');
                return;
            }

            showLoading();
            try {
                const response = await fetch('/api/generate-audit-plan', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ process_description: processDescription })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || `HTTP error! Status: ${response.status}`);
                }
                const data = await response.json();
                displayAnalysisResults(data);
            } catch (err) {
                console.error("Analysis Error:", err);
                showError(`Analysis Error: ${err.message}`);
            } finally {
                hideLoading();
            }
        });

        function displayAnalysisResults(data) {
            const resultsContainer = document.getElementById('results');
            resultsContainer.innerHTML = ''; // Clear previous results
            resultsContainer.style.display = 'block';

            // Introduction Card
            const introCard = document.createElement('div');
            introCard.className = 'card';
            introCard.innerHTML = `
                <div class="card-header">
                    <h2><i class="fas fa-user-shield"></i> Principal Auditor's Introduction</h2>
                </div>
                <div class="card-body"><p>${data.intro}</p></div>
            `;
            resultsContainer.appendChild(introCard);
            
            // Process Breakdown Card
            const breakdownCard = document.createElement('div');
            breakdownCard.className = 'card';
            breakdownCard.innerHTML = `<div class="card-header"><h2><i class="fas fa-sitemap"></i> Process & Risk Breakdown</h2></div>`;
            const breakdownBody = document.createElement('div');
            breakdownBody.className = 'card-body';
            
            data.process_breakdown.forEach((step, index) => {
                const stepElement = document.createElement('div');
                stepElement.className = 'process-step';

                const subStepsHtml = step.sub_steps.map(subStep => `
                    <div class="sub-step">
                        <h4 class="sub-step-title">${step.step_number}.${subStep.sub_step}</h4>
                        <div class="details-grid">
                            ${createTile('Root Cause Analysis', 'tile-root-cause', 'fa-search-plus', subStep.root_cause_analysis)}
                            ${createTile('Identified Risks', 'tile-identified-risks', 'fa-exclamation-triangle', subStep.identified_risks)}
                            ${createTile('Leading Questions', 'tile-leading-questions', 'fa-question-circle', subStep.leading_questions)}
                        </div>
                    </div>
                `).join('');

                stepElement.innerHTML = `
                    <div class="step-header ${index === 0 ? 'active' : ''}">
                        <h3 class="step-title">${step.step_number}. ${step.step_description}</h3>
                        <i class="fas fa-chevron-down step-toggle-icon"></i>
                    </div>
                    <div class="step-content" ${index === 0 ? 'style="display:block;"' : ''}>
                        ${subStepsHtml}
                    </div>
                `;
                breakdownBody.appendChild(stepElement);
            });
            
            breakdownCard.appendChild(breakdownBody);
            resultsContainer.appendChild(breakdownCard);
            
            // Add event listeners after rendering
            addEventListeners();
        }

        function createTile(title, className, icon, items) {
            if (!items || items.length === 0) return '';
            
            const listItems = items.map(item => `<li>${item}</li>`).join('');
            const isExpandable = items.join(' ').length > 250; // Simple length check to decide on expand button

            return `
                <div class="details-tile ${className}">
                    <div class="tile-header"><i class="fas ${icon}"></i> ${title}</div>
                    <div class="tile-content" data-expandable="${isExpandable}">
                        <ul>${listItems}</ul>
                        ${isExpandable ? '<button class="expand-btn">Show More</button>' : ''}
                    </div>
                </div>
            `;
        }

        function addEventListeners() {
            // Accordion logic
            document.querySelectorAll('.step-header').forEach(header => {
                header.addEventListener('click', () => {
                    const content = header.nextElementSibling;
                    header.classList.toggle('active');
                    content.style.display = content.style.display === 'block' ? 'none' : 'block';
                });
            });

            // Tile expansion logic
            document.querySelectorAll('.expand-btn').forEach(button => {
                button.addEventListener('click', () => {
                    const content = button.parentElement;
                    content.classList.toggle('expanded');
                    button.textContent = content.classList.contains('expanded') ? 'Show Less' : 'Show More';
                });
            });
        }
    </script>
</body>
</html>
